"""
Vulnerability Registry Phase 2.

Responsibility boundaries:
- Maintains node vulnerability dictionaries and privilege tracking.
- Implements global zero-day revelation logic.
"""

from typing import Dict, List, Set
from vulnerabilities.privilege_model import PrivilegeLevel
from vulnerabilities.vulnerability import Vulnerability
from vulnerabilities.exploit import Exploit
from utils.rng import CentralizedRNG


class NodeNotRegisteredError(Exception):
    pass


class InvalidPrivilegeEscalationError(Exception):
    pass


class VulnerabilityRegistry:
    """
    Isolated security-state layer.
    Manages node vulnerabilities and privileges without coupling to GraphManager.
    """

    def __init__(self) -> None:
        self._node_vulnerabilities: Dict[str, Dict[str, Vulnerability]] = {}
        self._node_privileges: Dict[str, PrivilegeLevel] = {}
        self._global_zero_days: Set[str] = set()

    def register_node(self, node_id: str) -> None:
        if node_id not in self._node_vulnerabilities:
            self._node_vulnerabilities[node_id] = {}
            self._node_privileges[node_id] = PrivilegeLevel.NONE

    def add_vulnerability(self, node_id: str, vulnerability: Vulnerability) -> None:
        if node_id not in self._node_vulnerabilities:
            raise NodeNotRegisteredError(f"Node '{node_id}' is not registered.")

        self._node_vulnerabilities[node_id][vulnerability.vuln_id] = vulnerability
        if vulnerability.zero_day:
            self._global_zero_days.add(vulnerability.vuln_id)

    def get_visible_vulnerabilities(self, node_id: str) -> List[Vulnerability]:
        if node_id not in self._node_vulnerabilities:
            raise NodeNotRegisteredError(f"Node '{node_id}' is not registered.")

        return [v for v in self._node_vulnerabilities[node_id].values() if v.is_visible()]

    def get_all_vulnerabilities(self, node_id: str) -> List[Vulnerability]:
        if node_id not in self._node_vulnerabilities:
            raise NodeNotRegisteredError(f"Node '{node_id}' is not registered.")

        return list(self._node_vulnerabilities[node_id].values())

    def reveal_zero_day(self, vuln_id: str) -> None:
        """Globally reveal a zero-day vulnerability making it visible on all nodes."""
        if vuln_id in self._global_zero_days:
            for node_vulns in self._node_vulnerabilities.values():
                if vuln_id in node_vulns:
                    node_vulns[vuln_id].reveal()
            self._global_zero_days.remove(vuln_id)

    def escalate_privilege(self, node_id: str, new_level: PrivilegeLevel) -> None:
        if node_id not in self._node_privileges:
            raise NodeNotRegisteredError(f"Node '{node_id}' is not registered.")

        current = self._node_privileges[node_id]
        if new_level < current:
            raise InvalidPrivilegeEscalationError(
                f"Cannot downgrade privilege. Current: {current.name}, Requested: {new_level.name}"
            )
        if new_level > PrivilegeLevel.max_level():
            raise InvalidPrivilegeEscalationError(
                f"Cannot exceed ROOT privilege. Requested: {new_level.name}"
            )

        self._node_privileges[node_id] = new_level

    def get_privilege(self, node_id: str) -> PrivilegeLevel:
        if node_id not in self._node_privileges:
            raise NodeNotRegisteredError(f"Node '{node_id}' is not registered.")
        return self._node_privileges[node_id]

    def reset_privilege(self, node_id: str) -> None:
        """Reset privilege of a node to USER level."""
        if node_id not in self._node_privileges:
            raise NodeNotRegisteredError(f"Node '{node_id}' is not registered.")
        # Ensure it doesn't violate monotonicity if we were at NONE
        current = self._node_privileges[node_id]
        if current < PrivilegeLevel.USER:
            self._node_privileges[node_id] = PrivilegeLevel.USER
        # If it was higher (ADMIN/ROOT), we force it to USER (resetting)
        else:
            self._node_privileges[node_id] = PrivilegeLevel.USER

    def patch_vulnerabilities(self, node_id: str) -> None:
        """Clear all vulnerabilities from a node."""
        if node_id not in self._node_vulnerabilities:
            raise NodeNotRegisteredError(f"Node '{node_id}' is not registered.")
        self._node_vulnerabilities[node_id].clear()

    def get_node_count(self) -> int:
        """Return number of registered nodes."""
        return len(self._node_privileges)


if __name__ == "__main__":
    # Mocking RNG for deterministic test
    class MockRNG:
        def uniform(self, low, high):
            return 0.5  # Deterministic 50% roll

    class MockCentralizedRNG(CentralizedRNG):
        def __init__(self):
            super().__init__()
            self._rng_instance = MockRNG()

    print("--- Phase 2 self-test ---")
    registry = VulnerabilityRegistry()
    
    # 1. Register node
    node_id = "n1"
    registry.register_node(node_id)
    print(f"Registered node: {node_id}")

    # 2. Add vulnerabilities
    vuln_normal = Vulnerability(vuln_id="CVE-2023-111", severity=7.5, required_privilege=PrivilegeLevel.NONE, zero_day=False)
    vuln_0day = Vulnerability(vuln_id="ZD-999", severity=10.0, required_privilege=PrivilegeLevel.ADMIN, zero_day=True)
    
    registry.add_vulnerability(node_id, vuln_normal)
    registry.add_vulnerability(node_id, vuln_0day)
    
    # 3. Print visible (zero-day heavily hidden)
    print("\nVisible Vulnerabilities (before reveal):")
    for v in registry.get_visible_vulnerabilities(node_id):
        print(f"  - {v}")

    # 4. Attempt exploit at USER
    rng = MockCentralizedRNG()
    exploit_0day = Exploit(exploit_id="EXP-999", target_vuln_id="ZD-999", base_success_probability=0.8, stealth_cost=5.0)
    
    registry.escalate_privilege(node_id, PrivilegeLevel.USER)
    curr_priv = registry.get_privilege(node_id)
    print(f"\nCurrent Privilege: {curr_priv.name}")
    
    success = exploit_0day.attempt(curr_priv, vuln_0day, rng)
    print(f"Exploit attempt on {vuln_0day.vuln_id} with probability {exploit_0day.base_success_probability} with roll 0.5: {'SUCCESS' if success else 'FAILED (Insufficient Privilege)'}")

    # 5. Escalate to ADMIN
    registry.escalate_privilege(node_id, PrivilegeLevel.ADMIN)
    curr_priv = registry.get_privilege(node_id)
    print(f"\nEscalated Privilege: {curr_priv.name}")

    # 6. Attempt exploit again
    success = exploit_0day.attempt(curr_priv, vuln_0day, rng)
    print(f"Exploit attempt on {vuln_0day.vuln_id} with probability {exploit_0day.base_success_probability} with roll 0.5: {'SUCCESS' if success else 'FAILED'}")

    # 7. Reveal zero-day
    print(f"\nRevealing global zero-day ZD-999...")
    registry.reveal_zero_day("ZD-999")

    # 8. Print visible after reveal
    print("\nVisible Vulnerabilities (after reveal):")
    for v in registry.get_visible_vulnerabilities(node_id):
        print(f"  - {v}")
