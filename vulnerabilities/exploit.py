"""
Exploit Payload Entity Phase 2.

Responsibility boundaries:
- Defines the active payload matching a `Vulnerability`.
- Tests execution success deterministically via centralized RNG.

Mutation constraints:
- Must not mutate vulnerability or registry.
"""

from vulnerabilities.privilege_model import PrivilegeLevel
from vulnerabilities.vulnerability import Vulnerability
from utils.rng import CentralizedRNG


class Exploit:
    """
    An executable adversarial package against a given host context.
    """

    def __init__(self, exploit_id: str, target_vuln_id: str, base_success_probability: float, stealth_cost: float):
        self.exploit_id = exploit_id
        self.target_vuln_id = target_vuln_id
        self.base_success_probability = max(0.0, min(1.0, base_success_probability))
        self.stealth_cost = stealth_cost

    def attempt(self, current_privilege: PrivilegeLevel, vulnerability: Vulnerability, rng: CentralizedRNG) -> bool:
        """
        Attempt to execute the exploit against the vulnerability.

        Args:
            current_privilege: The attacker's current privilege level.
            vulnerability: The target vulnerability.
            rng: Centralized deterministic random number generator.

        Returns:
            True if successful, False otherwise.
        """
        if self.target_vuln_id != vulnerability.vuln_id:
            return False

        if current_privilege < vulnerability.required_privilege:
            return False

        # Must use the centralized RNG to ensure reproducibility
        roll = rng.uniform(0.0, 1.0)
            
        return roll <= self.base_success_probability
